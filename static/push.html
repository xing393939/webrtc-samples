<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>主播端</title>
    <style>
        video {
            object-fit: cover;
        }
    </style>
</head>
<body>
<table>
    <tr>
        <td>
            <video id="video" autoplay></video>
        </td>
        <td>
            <div id="log"></div>
        </td>
    </tr>
</table>

<script src="peer.min.js"></script>
<script>
    (function () {
        var log = function (msg) {
            document.getElementById('log').innerHTML += msg + '<br />';
        };

        var serverId = (+new Date).toString(36) + '_' + (Math.random().toString()).split('.')[1];

        var peer = new Peer(serverId, {
            host: '120.27.32.78',
            port: 9003,
            path: '/api',
            config: {
                'iceServers': [
                    {url: 'stun:stunserver.org?transport=tcp'}
                ]
            }
        });

        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

        var constraints = {
            audio: false,
            video: true
        };

        navigator.getUserMedia(constraints, function (stream) {
            window.stream = stream;
            log('获取摄像头成功！');
            log('主播ID（' + serverId + '）...');
            log('等待连接...');
            var video = document.getElementById('video');
            if (window.URL) {
                video.src = window.URL.createObjectURL(stream);
            } else {
                video.src = stream;
            }
        }, function (err) {
            log('获取摄像头失败！');
        });

        peer.on('connection', function (conn) {

            getConnectionDetails(conn.pc);

            conn.on('data', function (clientId) {
                log('新连接：' + clientId);
                var call = peer.call(clientId, window.stream);

                call.on('close', function () {
                    log('已关闭：' + clientId);
                });
            });
        });
    })();


    function getConnectionDetails(peerConnection) {
        var connectionDetails = {};

        if (window.chrome) {  // checking if chrome
            var reqFields = [   'googLocalAddress',
                'googLocalCandidateType',
                'googRemoteAddress',
                'googRemoteCandidateType'
            ];
            peerConnection.getStats(function (stats) {
                var res = stats.result();
                console.log(res)
                console.log(res[0].stat(function(s) {
                    console.log(s)
                }))

                var filtered = stats.result().filter(function (e) {
                    return e.id.indexOf('Conn-audio') == 0 && e.stat('googActiveConnection') == 'true'
                })[0];
                if (!filtered) {
                    console.log('no filtered');
                    return;
                }
                reqFields.forEach(function (e) {
                    connectionDetails[e.replace('goog', '')] = filtered.stat(e)
                });
                console.log(connectionDetails);
            });
        } else {  // assuming it is firefox
            peerConnection.getStats(function (stats) {
                var selectedCandidatePair = stats[Object.keys(stats).filter(function (key) {
                            return stats[key].selected
                        })[0]]
                        , localICE = stats[selectedCandidatePair.localCandidateId]
                        , remoteICE = stats[selectedCandidatePair.remoteCandidateId];
                connectionDetails.LocalAddress = [localICE.ipAddress, localICE.portNumber].join(':');
                connectionDetails.RemoteAddress = [remoteICE.ipAddress, remoteICE.portNumber].join(':');
                connectionDetails.LocalCandidateType = localICE.candidateType;
                connectionDetails.RemoteCandidateType = remoteICE.candidateType;
                console.log(connectionDetails);
            });
        }
    }

</script>
</body>
</html>
