<html>
<body>
<p>
    你的角色是：<span id="role"></span>
</p>
<input type="text" id="msg" /><button id="btn">发送</button>
<br />
<div id="room"></div>

<script src="peer.min.js"></script>
<script>
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    navigator.getUserMedia({audio: false,video: true}, function (stream) {
        window.stream = stream;
    }, function (err) {});

    var ids = ['user0', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7'];
    var idsTmp = ['user0', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7'];
    var connectedConn = [];

    function newPeer(nextAct) {
        var id = idsTmp.shift();
        var peer = new Peer(id, {
            host: '120.27.32.78',
            port: 9003,
            path: '/api',
            config: {
                'iceServers': [
                    {url: 'stun:120.27.32.78:3478'}
                ]
            }
        });
        peer.on('error', function (err) {
            if (err.type == 'unavailable-id')
                newPeer(nextAct);
        });
        peer.on('open', function () {
            nextAct(peer);
        });
    }

    newPeer(function (peer) {
        document.getElementById('role').innerHTML = peer.id;

        ids.map(function (id) {
            if (id == peer.id) return;

            //主动连接上
            var conn = peer.connect(id)
            conn.on('open', function () {
                connectedConn[conn.peer] = conn;
            })
            conn.on('close', function() {
                delete connectedConn[conn.peer];
            })
            conn.on('data', function (str) {
                document.getElementById('room').innerHTML += '<p>' + conn.peer + ': ' + str + '</p>';
            })
        })

        // 被动视频语音
        peer.on('call', function (call) {
            call.answer(window.stream)
            call.on('stream', function (remoteStream) {
                console.log(remoteStream)
            })
        });

        //被动连接上
        peer.on('connection', function (conn) {
            connectedConn[conn.peer] = conn;
            conn.on('close', function() {
                delete connectedConn[conn.peer];
            })

            conn.on('data', function (str) {
                document.getElementById('room').innerHTML += '<p>' + conn.peer + ': ' + str + '</p>';
            })
        });

        document.getElementById('btn').onclick = function() {
            var val = document.getElementById('msg').value;
            document.getElementById('room').innerHTML += '<p>' + peer.id + ': ' + val + '</p>';

            console.log(connectedConn);
            for(var k in connectedConn) {
                connectedConn[k].send(val);
            }
        }
    })
</script>
</body>
</html>