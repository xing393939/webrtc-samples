<html>
<head>
    <meta charset="utf-8"/>
    <title>主播端</title>
    <style>
        #room_media li {display: inline-block; list-style: none; margin-right: 15px;}
    </style>
</head>
<body>
<p>
    你的角色是：<span id="role"></span>
</p>
<ul id="room_media"></ul>
<input type="text" id="msg" /> <button id="btn">发送</button>
<br />
<div id="room"></div>

<script src="peer.min.js"></script>
<script>
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    navigator.getUserMedia({audio: true, video: false}, function (stream) {
        window.localStream = stream;
    }, function (err) {});

    var ids = ['user0', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7'];
    var idsTmp = ['user0', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7'];
    var connectedConn = [];
    var connectedMedia = [];

    function newPeer(nextAct) {
        var id = idsTmp.shift();
        var peer = new Peer(id, {
            host: '120.27.32.78',
            port: 9003,
            path: '/api',
            config: {
                'iceServers': [
                    {url: 'stun:120.27.32.78:3478'}
                ]
            }
        });
        peer.on('error', function (err) {
            if (err.type == 'unavailable-id')
                newPeer(nextAct);
        });
        peer.on('open', function () {
            nextAct(peer);
        });
    }

    newPeer(function (peer) {
        document.getElementById('role').innerHTML = peer.id;

        ids.map(function (id) {
            if (id == peer.id) return;

            //主动连接上
            var conn = peer.connect(id)
            conn.on('open', function () {
                connectedConn[conn.peer] = conn;
                //conn.addStream(window.localStream)
                var call = peer.call(conn.peer, window.localStream);
                conn.on('close', function() {
                    delete connectedConn[conn.peer];
                })
                conn.on('data', function (str) {
                    document.getElementById('room').innerHTML += '<p>' + conn.peer + ': ' + str + '</p>';
                })
            })
        })

        // 被动视频语音
        peer.on('call', function (call) {
            call.answer(window.localStream)
            call.on('stream', function (remoteStream) {
                connectedMedia[call.peer] = remoteStream;
                showMedia();
            })
        });

        //被动连接上
        peer.on('connection', function (conn) {
            connectedConn[conn.peer] = conn;
            //conn.addStream(window.localStream)
            var call = peer.call(conn.peer, window.localStream);
            conn.on('close', function() {
                delete connectedConn[conn.peer];
            })
            conn.on('data', function (str) {
                document.getElementById('room').innerHTML += '<p>' + conn.peer + ': ' + str + '</p>';
            })
        });

        document.getElementById('btn').onclick = function() {
            var val = document.getElementById('msg').value;
            document.getElementById('room').innerHTML += '<p>' + peer.id + ': ' + val + '</p>';

            console.log(connectedConn);
            for(var k in connectedConn) {
                connectedConn[k].send(val);
            }
        }
    })

    function showMedia() {
        var room_media = document.getElementById('room_media');
        room_media.innerHTML = '';
        for(var k in connectedMedia) {
            var video = document.createElement('video');
            video.width = 200
            video.autoplay = true
            var li = document.createElement('li');
            li.innerHTML = k + '<br />';
            li.appendChild(video);
            room_media.appendChild(li);
            if (window.URL) {
                video.src = window.URL.createObjectURL(connectedMedia[k]);
            } else {
                video.src = connectedMedia[k];
            }
        }
    }
</script>
</body>
</html>